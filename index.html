<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>Clarity - AI 指令优化工具</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['-apple-system', 'BlinkMacSystemFont', 'Inter', 'SF Pro Text', 'Helvetica Neue', 'sans-serif'],
            },
            colors: {
              glass: {
                border: 'rgba(255, 255, 255, 0.3)',
                surface: 'rgba(255, 255, 255, 0.45)',
                highlight: 'rgba(255, 255, 255, 0.6)',
              }
            },
            boxShadow: {
              'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.05)',
              'glass-hover': '0 8px 32px 0 rgba(31, 38, 135, 0.1)',
            },
            animation: {
              'fade-in': 'fadeIn 0.5s ease-out',
              'slide-up': 'slideUp 0.5s ease-out',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              slideUp: {
                '0%': { transform: 'translateY(10px)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
              }
            }
          },
        },
      }
    </script>

    <!-- Global Styles -->
    <style>
      body {
        background-color: #f5f5f7;
        /* Apple-style mesh gradient background */
        background-image: 
          radial-gradient(at 0% 0%, hsla(253,16%,7%,0) 0, transparent 50%), 
          radial-gradient(at 50% 0%, hsla(225,39%,30%,0) 0, transparent 50%), 
          radial-gradient(at 100% 0%, hsla(339,49%,30%,0) 0, transparent 50%);
        background-attachment: fixed;
        -webkit-font-smoothing: antialiased;
        color: #1d1d1f;
      }
      
      /* Glassmorphism Utilities */
      .glass-panel {
        background: rgba(255, 255, 255, 0.55);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.4);
      }
      
      .glass-input {
        background: rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.2);
      }

      /* Hide number input spinners */
      input[type=number]::-webkit-inner-spin-button, 
      input[type=number]::-webkit-outer-spin-button { 
        -webkit-appearance: none; 
        margin: 0; 
      }
    </style>

    <!-- Import Map for React -->
    <!-- Fixed: Removed conflicting React 19 entries and unused libs to prevent version mismatch errors -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.38.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';

        // --- ICONS (Inline SVG to avoid dependency issues) ---
        const Icons = {
            Sparkles: ({ className }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, React.createElement("path", { d: "m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" })),
            Zap: ({ className }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, React.createElement("polygon", { points: "13 2 3 14 12 14 11 22 21 10 12 10 13 2" })),
            ArrowRight: ({ className }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, React.createElement("path", { d: "M5 12h14" }), React.createElement("path", { d: "m12 5 7 7-7 7" })),
            Check: ({ className }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, React.createElement("polyline", { points: "20 6 9 17 4 12" })),
            Copy: ({ className }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, React.createElement("rect", { width: "14", height: "14", x: "8", y: "8", rx: "2", ry: "2" }), React.createElement("path", { d: "M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" })),
            RefreshCw: ({ className }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, React.createElement("path", { d: "M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" }), React.createElement("path", { d: "M21 3v5h-5" }), React.createElement("path", { d: "M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" }), React.createElement("path", { d: "M8 16H3v5" })),
            Key: ({ className }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, React.createElement("circle", { cx: "7.5", cy: "15.5", r: "5.5" }), React.createElement("path", { d: "m21 2-9.6 9.6" }), React.createElement("path", { d: "m15.5 7.5 3 3L22 7l-3-3" })),
            Eye: ({ className }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, React.createElement("path", { d: "M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" }), React.createElement("circle", { cx: "12", cy: "12", r: "3" })),
            EyeOff: ({ className }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, React.createElement("path", { d: "M9.88 9.88a3 3 0 1 0 4.24 4.24" }), React.createElement("path", { d: "M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" }), React.createElement("path", { d: "M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7c.44 0 .87-.03 1.28-.09" }), React.createElement("line", { x1: "2", x2: "22", y1: "2", y2: "22" })),
            ShieldCheck: ({ className }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, React.createElement("path", { d: "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" }), React.createElement("path", { d: "m9 12 2 2 4-4" })),
            Settings: ({ className }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, React.createElement("path", { d: "M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" }), React.createElement("circle", { cx: "12", cy: "12", r: "3" })),
            ChevronDown: ({ className }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, React.createElement("path", { d: "m6 9 6 6 6-6" })),
            ChevronUp: ({ className }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, React.createElement("path", { d: "m18 15-6-6-6 6" })),
            AlertTriangle: ({ className }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, React.createElement("path", { d: "m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" }), React.createElement("path", { d: "M12 9v4" }), React.createElement("path", { d: "M12 17h.01" })),
        };

        // --- GEMINI SERVICE (FETCH Implementation for Browser) ---
        // Using direct fetch to avoid dependency complexity in single-file setup
        
        async function callGemini(apiKey, model, prompt, responseSchema = null) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            const body = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {}
            };

            if (responseSchema) {
                body.generationConfig.responseMimeType = "application/json";
                body.generationConfig.responseSchema = responseSchema;
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!text) throw new Error("No text returned from Gemini");
                return text;
            } catch (error) {
                console.error("Gemini API Call Failed:", error);
                throw error;
            }
        }

        const GeminiService = {
            generateFastPrompt: async (userInput, apiKey) => {
                const prompt = `
                    Act as an expert prompt engineer. 
                    Transform the following raw, potentially unstructured user input into a single, high-quality, structured AI prompt in Chinese.
                    
                    Rules:
                    1. Output ONLY the optimized prompt in Simplified Chinese. No introductory text.
                    2. Use professional, neutral, and clear language.
                    3. Remove emotional or filler language.
                    4. Structure with clear headers or bullet points if necessary.
                    5. Do not ask for clarification; make reasonable professional assumptions.

                    Raw Input:
                    "${userInput}"
                `;
                return callGemini(apiKey, 'gemini-1.5-flash', prompt);
            },

            generateClarificationQuestions: async (userInput, apiKey) => {
                const prompt = `
                    Analyze the following user input for an AI task. 
                    Perform an implicit clarification to smooth out rough edges, then identify up to 3 CRITICAL strategic decisions that are ambiguous.
                    Generate 2-3 multiple choice questions that will help define the direction, style, or goal of the final prompt.

                    User Input: "${userInput}"

                    Requirements:
                    1. Maximum 3 questions.
                    2. Questions must be high-level strategic (e.g., Tone, Depth, Format), not trivial.
                    3. Options must be mutually exclusive and significantly distinct.
                    4. ALL text (questions and options) MUST be in Simplified Chinese.
                    5. Return valid JSON only with keys: "id", "text", "options" (array of "id", "label", "value").
                `;
                
                // Schema definition for Gemini
                const schema = {
                    type: "OBJECT",
                    properties: {
                        questions: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    id: { type: "STRING" },
                                    text: { type: "STRING" },
                                    options: {
                                        type: "ARRAY",
                                        items: {
                                            type: "OBJECT",
                                            properties: {
                                                id: { type: "STRING" },
                                                label: { type: "STRING" },
                                                value: { type: "STRING" }
                                            },
                                            required: ["id", "label", "value"]
                                        }
                                    }
                                },
                                required: ["id", "text", "options"]
                            }
                        }
                    }
                };

                const text = await callGemini(apiKey, 'gemini-1.5-flash', prompt, schema);
                try {
                    const json = JSON.parse(text);
                    return json.questions || [];
                } catch (e) {
                    console.error("JSON Parse Error", e);
                    throw new Error("解析澄清问题失败");
                }
            },

            generateFinalClarifiedPrompt: async (originalInput, qaPairs, apiKey) => {
                const qaContext = qaPairs.map(qa => `Q: ${qa.question}\nChoice: ${qa.answer}`).join("\n\n");
                const prompt = `
                    Act as an expert prompt engineer.
                    Task: Create a final, highly optimized prompt based on the User's Original Input and their Strategic Choices.

                    Original Input:
                    "${originalInput}"

                    Strategic Choices:
                    ${qaContext}

                    Output Requirements:
                    1. Produce a single, cohesive, ready-to-use prompt in Simplified Chinese.
                    2. Incorporate the strategic choices naturally into the instructions.
                    3. Use a clean, structured format (Markdown).
                    4. Tone: Professional, direct, and sophisticated.
                    5. Do not explain your reasoning. Output ONLY the final prompt.
                `;
                return callGemini(apiKey, 'gemini-1.5-pro', prompt); // Use Pro for smarter final synth
            }
        };


        // --- COMPONENTS ---

        // Glass Button
        const GlassButton = ({ children, variant = 'primary', isLoading = false, className = '', disabled, ...props }) => {
            const baseStyle = "relative overflow-hidden rounded-full px-6 py-3 text-sm font-medium transition-all duration-300 ease-out focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-white/60 hover:bg-white/80 text-slate-900 shadow-glass border border-white/40 backdrop-blur-md",
                secondary: "bg-slate-200/40 hover:bg-slate-200/60 text-slate-700 border border-transparent",
                ghost: "bg-transparent hover:bg-white/30 text-slate-600",
            };

            return React.createElement("button", { 
                className: `${baseStyle} ${variants[variant]} ${className}`,
                disabled: disabled || isLoading,
                ...props
            }, [
                React.createElement("span", { key: "content", className: `flex items-center justify-center gap-2 ${isLoading ? 'opacity-0' : 'opacity-100'}` }, children),
                isLoading && React.createElement("div", { key: "loader", className: "absolute inset-0 flex items-center justify-center" }, 
                    React.createElement("svg", { className: "animate-spin h-5 w-5 text-slate-600", xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24" },
                        React.createElement("circle", { className: "opacity-25", cx: "12", cy: "12", r: "10", stroke: "currentColor", strokeWidth: "4" }),
                        React.createElement("path", { className: "opacity-75", fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })
                    )
                )
            ]);
        };

        // Mode Toggle
        const ModeToggle = ({ currentMode, onModeChange, disabled }) => {
            return React.createElement("div", { className: "bg-white/10 p-1 rounded-full flex relative w-full sm:w-auto backdrop-blur-sm border border-white/20" }, [
                React.createElement("div", { 
                    key: "bg",
                    className: "absolute top-1 bottom-1 w-[calc(50%-4px)] bg-white/40 rounded-full shadow-sm transition-all duration-300 ease-out z-0 backdrop-blur-md",
                    style: { left: currentMode === 'FAST' ? '4px' : 'calc(50% + 0px)' }
                }),
                React.createElement("button", {
                    key: "fast",
                    onClick: () => onModeChange('FAST'),
                    disabled: disabled,
                    className: `relative z-10 flex-1 sm:flex-none flex items-center justify-center gap-2 px-6 py-2 rounded-full text-sm font-medium transition-colors duration-200 w-full sm:w-40 ${currentMode === 'FAST' ? 'text-slate-900' : 'text-slate-500 hover:text-slate-700'}`
                }, [
                    React.createElement(Icons.Zap, { key: "icon", size: 14, className: currentMode === 'FAST' ? 'fill-yellow-400 text-yellow-400' : '' }),
                    "快速生成"
                ]),
                React.createElement("button", {
                    key: "clarify",
                    onClick: () => onModeChange('CLARIFY'),
                    disabled: disabled,
                    className: `relative z-10 flex-1 sm:flex-none flex items-center justify-center gap-2 px-6 py-2 rounded-full text-sm font-medium transition-colors duration-200 w-full sm:w-40 ${currentMode === 'CLARIFY' ? 'text-slate-900' : 'text-slate-500 hover:text-slate-700'}`
                }, [
                    React.createElement(Icons.Sparkles, { key: "icon", size: 14, className: currentMode === 'CLARIFY' ? 'fill-purple-400 text-purple-400' : '' }),
                    "澄清生成"
                ])
            ]);
        };

        // API Key Config (Collapsed)
        const ApiKeyConfig = ({ onApiKeyChange }) => {
            const [key, setKey] = useState('');
            const [isVisible, setIsVisible] = useState(false);
            const [isOpen, setIsOpen] = useState(false);
            const [isFocused, setIsFocused] = useState(false);

            useEffect(() => {
                const storedKey = localStorage.getItem('user_gemini_api_key');
                if (storedKey) {
                    setKey(storedKey);
                    onApiKeyChange(storedKey);
                }
            }, []); // Run once on mount

            const handleKeyChange = (e) => {
                const newValue = e.target.value.trim();
                setKey(newValue);
                localStorage.setItem('user_gemini_api_key', newValue);
                onApiKeyChange(newValue);
            };

            const hasKey = key.length > 0;

            return React.createElement("div", { className: "w-full flex flex-col items-center animate-fade-in" }, [
                // Trigger Button
                React.createElement("button", {
                    key: "trigger",
                    onClick: () => setIsOpen(!isOpen),
                    className: `flex items-center gap-2 px-4 py-2 rounded-full text-xs font-medium transition-all duration-300 border backdrop-blur-md ${hasKey ? 'bg-slate-200/30 text-slate-500 border-slate-200/50 hover:bg-slate-200/50 hover:text-slate-700' : 'bg-amber-50/80 text-amber-600 border-amber-200/50 hover:bg-amber-100/80 shadow-sm'}`
                }, [
                    hasKey ? React.createElement(Icons.Settings, { key: "icon", size: 12 }) : React.createElement(Icons.Key, { key: "icon", size: 12 }),
                    React.createElement("span", { key: "text" }, hasKey ? 'API 设置' : '配置 Google API Key'),
                    isOpen ? React.createElement(Icons.ChevronUp, { key: "arrow", size: 12 }) : React.createElement(Icons.ChevronDown, { key: "arrow", size: 12 })
                ]),

                // Content
                React.createElement("div", {
                    key: "content",
                    className: `w-full max-w-lg overflow-hidden transition-all duration-500 ease-[cubic-bezier(0.32,0.72,0,1)] ${isOpen ? 'max-h-48 opacity-100 mt-4' : 'max-h-0 opacity-0 mt-0'}`
                }, 
                    React.createElement("div", { 
                        className: `relative rounded-2xl border transition-all duration-300 ${isFocused ? 'bg-white/70 border-white/60 shadow-glass-hover' : 'bg-white/40 border-white/30 shadow-glass'} backdrop-blur-xl mx-1`
                    }, [
                        React.createElement("div", { key: "input-wrap", className: "flex items-center p-2 gap-3" }, 
                            React.createElement("div", { className: "flex-1 relative" }, [
                                React.createElement("div", { key: "icon-l", className: "absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" }, React.createElement(Icons.Key, { size: 14 })),
                                React.createElement("input", {
                                    key: "input",
                                    type: isVisible ? "text" : "password",
                                    value: key,
                                    onChange: handleKeyChange,
                                    onFocus: () => setIsFocused(true),
                                    onBlur: () => setIsFocused(false),
                                    placeholder: "在此粘贴你的 Google AI Studio API Key",
                                    className: "w-full bg-transparent border-none text-sm text-slate-800 placeholder:text-slate-400/70 focus:ring-0 focus:outline-none py-2 pl-9 pr-8 font-mono tracking-tight",
                                    autoComplete: "off",
                                    spellCheck: "false"
                                }),
                                React.createElement("button", {
                                    key: "toggle",
                                    onClick: () => setIsVisible(!isVisible),
                                    className: "absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors p-1",
                                    title: isVisible ? "隐藏" : "显示"
                                }, isVisible ? React.createElement(Icons.EyeOff, { size: 14 }) : React.createElement(Icons.Eye, { size: 14 }))
                            ])
                        ),
                        React.createElement("div", { key: "footer", className: "bg-white/20 border-t border-white/20 px-3 py-1.5 flex items-center justify-center gap-1.5 text-[10px] text-slate-500" }, [
                            React.createElement(Icons.ShieldCheck, { key: "icon", size: 10, className: "text-slate-400" }),
                            React.createElement("span", { key: "text" }, "Key 仅存储于本地浏览器，直接请求 Google 接口")
                        ])
                    ])
                )
            ]);
        };

        // --- APP MAIN COMPONENT ---
        const App = () => {
            const [apiKey, setApiKey] = useState('');
            const [mode, setMode] = useState('FAST');
            const [input, setInput] = useState('');
            const [status, setStatus] = useState('IDLE');
            const [error, setError] = useState(null);
            
            const [questions, setQuestions] = useState([]);
            const [answers, setAnswers] = useState({});
            
            const [result, setResult] = useState('');
            const [copied, setCopied] = useState(false);

            const resultRef = useRef(null);
            const questionsRef = useRef(null);

            const handleModeChange = (newMode) => {
                if (status !== 'IDLE' && status !== 'COMPLETED') return;
                setMode(newMode);
                setQuestions([]);
                setAnswers({});
                setError(null);
                if (status === 'COMPLETED') {
                    setStatus('IDLE');
                    setResult('');
                }
            };

            const handleGenerate = async () => {
                if (!input.trim()) return;
                if (!apiKey) {
                    setError("请先在下方配置 Google API Key");
                    return;
                }
                setError(null);
                setResult('');
                setCopied(false);

                try {
                    if (mode === 'FAST') {
                        setStatus('GENERATING_RESULT');
                        const prompt = await GeminiService.generateFastPrompt(input, apiKey);
                        setResult(prompt);
                        setStatus('COMPLETED');
                    } else {
                        setStatus('GENERATING_QUESTIONS');
                        const generatedQuestions = await GeminiService.generateClarificationQuestions(input, apiKey);
                        setQuestions(generatedQuestions);
                        setStatus('AWAITING_INPUT');
                    }
                } catch (err) {
                    console.error(err);
                    const msg = err.message?.includes('API') || err.message?.includes('400') ? "API Key 无效或过期" : "生成失败，请稍后重试";
                    setError(msg);
                    setStatus('ERROR');
                }
            };

            const handleClarificationSubmit = async () => {
                try {
                    setStatus('GENERATING_RESULT');
                    const qaPairs = questions.map(q => ({
                        question: q.text,
                        answer: answers[q.id] || q.options[0].value
                    }));
                    const finalPrompt = await GeminiService.generateFinalClarifiedPrompt(input, qaPairs, apiKey);
                    setResult(finalPrompt);
                    setStatus('COMPLETED');
                } catch (err) {
                    setError("生成最终指令失败");
                    setStatus('ERROR');
                }
            };

            const copyToClipboard = () => {
                navigator.clipboard.writeText(result);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            const handleReset = () => {
                setStatus('IDLE');
                setResult('');
                setQuestions([]);
                setAnswers({});
                setError(null);
                setInput('');
            };

            useEffect(() => {
                if (status === 'AWAITING_INPUT' && questionsRef.current) {
                    questionsRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                if (status === 'COMPLETED' && resultRef.current) {
                    resultRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, [status]);

            const isBusy = status === 'GENERATING_QUESTIONS' || status === 'GENERATING_RESULT';

            return React.createElement("div", { className: "min-h-screen flex flex-col items-center py-12 px-4 sm:px-6 lg:px-8 text-slate-800" }, [
                // Main Container
                React.createElement("main", { 
                    key: "main",
                    className: "w-full max-w-3xl glass-panel rounded-[40px] p-6 sm:p-10 transition-all duration-500 mb-8"
                }, [
                    // Header
                    React.createElement("div", { key: "header", className: "flex flex-col items-center mb-8 text-center relative z-10" }, [
                        React.createElement("div", { key: "logo", className: "w-12 h-12 bg-gradient-to-tr from-slate-100 to-white/40 rounded-2xl shadow-sm border border-white/30 flex items-center justify-center mb-6 backdrop-blur-md" }, 
                            React.createElement(Icons.Sparkles, { className: "text-slate-500", size: 24 })
                        ),
                        React.createElement("h1", { key: "title", className: "text-2xl font-semibold tracking-tight text-slate-900 mb-2" }, "优化你的想法"),
                        React.createElement("p", { key: "desc", className: "text-slate-500 font-normal" }, "将零散的想法转化为精准的 AI 指令。")
                    ]),

                    // Mode Toggle
                    React.createElement("div", { key: "toggle", className: "flex justify-center mb-8 relative z-0" }, 
                        React.createElement(ModeToggle, { currentMode: mode, onModeChange: handleModeChange, disabled: isBusy || (status !== 'IDLE' && status !== 'COMPLETED') })
                    ),

                    // Input
                    React.createElement("div", { key: "input-area", className: "space-y-4" }, [
                        React.createElement("div", { key: "textarea-wrap", className: "relative group" }, [
                            React.createElement("textarea", {
                                key: "textarea",
                                className: "w-full h-40 glass-input hover:bg-white/40 focus:bg-white/50 rounded-3xl p-6 text-lg placeholder:text-slate-400/80 focus:outline-none focus:ring-0 transition-all resize-none shadow-inner text-slate-800",
                                placeholder: "在这里描述你的想法... 不必在意结构。",
                                value: input,
                                onChange: (e) => setInput(e.target.value),
                                disabled: isBusy || status === 'AWAITING_INPUT'
                            }),
                        ]),
                        
                        // Action Bar
                        React.createElement("div", { key: "actions", className: "flex justify-end pt-2 items-center gap-4" }, [
                            !apiKey && React.createElement("span", { key: "warning", className: "text-xs text-amber-600/80 font-medium flex items-center gap-1.5 px-3 py-1 bg-amber-50/50 rounded-full border border-amber-100/50" }, [
                                React.createElement(Icons.AlertTriangle, { key: "icon", size: 12 }),
                                "请先配置 API Key"
                            ]),
                            (status === 'IDLE' || status === 'COMPLETED' || status === 'ERROR') && React.createElement(GlassButton, {
                                key: "btn",
                                onClick: handleGenerate,
                                disabled: !input.trim() || !apiKey,
                                isLoading: isBusy,
                                className: !apiKey ? 'opacity-50 grayscale cursor-not-allowed' : ''
                            }, status === 'COMPLETED' ? '再次优化' : '生成指令', status !== 'COMPLETED' && React.createElement(Icons.ArrowRight, { size: 16 }))
                        ])
                    ]),

                    // Clarification Section
                    status === 'AWAITING_INPUT' && React.createElement("div", { key: "clarify", ref: questionsRef, className: "mt-10 animate-slide-up" }, [
                         React.createElement("div", { className: "flex items-center gap-3 mb-6 px-1" }, [
                             React.createElement("div", { className: "h-px bg-slate-200/50 flex-1" }),
                             React.createElement("span", { className: "text-xs font-medium text-slate-400 uppercase tracking-widest" }, "需要澄清"),
                             React.createElement("div", { className: "h-px bg-slate-200/50 flex-1" }),
                         ]),
                         React.createElement("p", { className: "text-slate-600 text-center mb-8 px-4" }, `我们已为你补全了大部分细节，请确认以下 ${questions.length} 个关键点。`),
                         React.createElement("div", { className: "space-y-8" }, questions.map(q => 
                             React.createElement("div", { key: q.id, className: "bg-white/10 rounded-3xl p-6 border border-white/20 backdrop-blur-sm" }, [
                                 React.createElement("h3", { key: "q-title", className: "text-md font-medium text-slate-900 mb-4" }, q.text),
                                 React.createElement("div", { key: "opts", className: "grid grid-cols-1 sm:grid-cols-2 gap-3" }, q.options.map(opt => {
                                     const isSelected = answers[q.id] === opt.value;
                                     return React.createElement("button", {
                                         key: opt.id,
                                         onClick: () => setAnswers(prev => ({ ...prev, [q.id]: opt.value })),
                                         className: `relative px-4 py-3 rounded-xl text-sm text-left transition-all duration-200 border ${isSelected ? 'bg-white/60 border-slate-200/50 shadow-sm text-slate-900' : 'bg-transparent border-transparent hover:bg-white/20 text-slate-600'}`
                                     }, [
                                         opt.label,
                                         isSelected && React.createElement("div", { key: "check", className: "absolute right-3 top-1/2 -translate-y-1/2 text-slate-800" }, React.createElement(Icons.Check, { size: 14 }))
                                     ])
                                 }))
                             ])
                         )),
                         React.createElement("div", { className: "flex justify-end mt-8" }, 
                             React.createElement(GlassButton, { onClick: handleClarificationSubmit, disabled: Object.keys(answers).length < questions.length }, "生成最终指令", React.createElement(Icons.ArrowRight, { size: 16 }))
                         )
                    ]),

                    // Error
                    error && React.createElement("div", { key: "error", className: "mt-6 p-4 rounded-2xl bg-red-50/20 border border-red-100/50 text-red-600 text-sm text-center backdrop-blur-md animate-fade-in" }, error),

                    // Result
                    status === 'COMPLETED' && result && React.createElement("div", { key: "result", ref: resultRef, className: "mt-12 pt-10 border-t border-slate-200/40 animate-slide-up" }, [
                        React.createElement("div", { className: "flex items-center justify-between mb-4" }, [
                            React.createElement("h3", { className: "text-sm font-semibold text-slate-400 uppercase tracking-wider" }, "优化后的指令"),
                            React.createElement("div", { className: "flex gap-2" }, [
                                React.createElement("button", { onClick: handleReset, className: "p-2 text-slate-400 hover:text-slate-600 transition-colors rounded-full hover:bg-white/30", title: "重新开始" }, React.createElement(Icons.RefreshCw, { size: 16 })),
                                React.createElement("button", { onClick: copyToClipboard, className: `flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium transition-all ${copied ? 'bg-emerald-100/80 text-emerald-700' : 'bg-slate-100/50 text-slate-600 hover:bg-slate-200/50'}` }, copied ? React.createElement(Icons.Check, { size: 12 }) : React.createElement(Icons.Copy, { size: 12 }), copied ? '已复制' : '复制')
                            ])
                        ]),
                        React.createElement("div", { className: "bg-white/30 backdrop-blur-md rounded-2xl border border-white/30 p-6 shadow-sm overflow-hidden relative" }, 
                            React.createElement("div", { className: "prose prose-slate prose-sm max-w-none text-slate-800 leading-relaxed whitespace-pre-wrap font-sans" }, result)
                        )
                    ])
                ]),

                // Footer Config
                React.createElement("div", { key: "config", className: "w-full max-w-3xl px-4 sm:px-10 mb-8 z-10" }, 
                    React.createElement(ApiKeyConfig, { onApiKeyChange: setApiKey })
                ),

                // Footer Text
                React.createElement("footer", { key: "footer", className: "text-center text-slate-400 text-xs pb-12" }, 
                    React.createElement("p", null, "由 Gemini 驱动。为清晰而设计。")
                )
            ]);
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>